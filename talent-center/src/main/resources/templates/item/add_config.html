<!DOCTYPE html>
<html>
@layout("/layout/_form_layout.html"){
<link href="/css/plugins/layer/laydate.css" rel="stylesheet" type="text/css">
<link href="/css/plugins/simditor/simditor.css" rel="stylesheet">
<link href="/css/plugins/webuploader/webuploader.css" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/bootstrap-table.min.css">
<style>
    #u-file{
        padding-top: 2px;
        margin-right: 10px;
    }
    .pt5{
        padding-bottom: 5px;
    }
</style>
<div class="row">
    <div class="col-sm-12">
        <div class="ibox float-e-margins">
            <div class="ibox-content">
                <form class="form-horizontal m-t" id="viladate_form">

                    <div class="form-group">
                        <label for="item_config_accept_begin" class="col-sm-2 control-label">申请受理时间：</label>
                        <div class="col-sm-3">
                            <input id="item_config_accept_begin" placeholder="请选择受理时间" name="itemConfigAccept"
                                   class="form-control" type="text" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="item_config_accept_begin" class="col-sm-2 control-label">审核时间：</label>
                        <div class="col-sm-3">
                            <input id="item_config_check_time" placeholder="请选择审核时间" name="itemConfigCheckTime"
                                   class="form-control" type="text" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="item_config_effect" class="col-sm-2 control-label">生效时间：</label>
                        <div class="col-sm-3">
                            <input id="item_config_effect" placeholder="请输入生效时间" name="itemConfigEffect"
                                   class="date-time form-control" type="text" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label" style="padding-top: 2px;">窗口办理：</label>
                        <div class="col-sm-3">
                            <div class="i-checks">
                                <label>
                                    <input type="radio" value="0" checked name="itemConfigFace"> <i></i> 否</label>&nbsp;&nbsp;
                                <label>
                                    <input type="radio" value="1" name="itemConfigFace"> <i></i> 是</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label" style="padding-top: 2px;">补助方式：</label>
                        <div class="col-sm-3">
                            <div class="i-checks">
                                <label>
                                    <input type="radio" value="1" checked name="itemConfigType"> <i></i> 现金</label>&nbsp;&nbsp;
                                <label>
                                    <input type="radio" value="0" name="itemConfigType"> <i></i> 服务</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-2 control-label" style="padding-top: 2px;">补助发放方式：</label>
                        <div class="col-sm-3">
                            <div class="i-checks">
                                <label>
                                    <input type="radio" value="0" checked name="itemConfigSendType"> <i></i> 一次性
                                </label>&nbsp;&nbsp;
                                <label>
                                    <input type="radio" value="1" name="itemConfigSendType"> <i></i> 月</label>&nbsp;&nbsp;
                                <label>
                                    <input type="radio" value="2" name="itemConfigSendType"> <i></i> 年</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-2 control-label" style="padding-top: 2px;">按人才分类：</label>
                        <div class="col-sm-3">
                            <div class="i-checks">
                                <label>
                                    <input type="radio" value="0" checked name="itemConfigTType"> <i></i> 否
                                </label>&nbsp;&nbsp;
                                <label>
                                    <input type="radio" value="1" name="itemConfigTType"> <i></i> 是</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="item_config_send_rate" class="col-sm-2 control-label">发放频率：</label>
                        <div class="col-sm-3">
                            <input id="item_config_send_rate" placeholder="请输入发放频率(例:0.5月发放一次)"
                                   name="itemConfigSendRate" class="form-control" type="number" readonly>
                        </div>
                    </div>

                    <!--<div class="form-group">
                        <label for="item_config_amount_total" class="col-sm-2 control-label">总补助金额：</label>
                        <div class="col-sm-3">
                            <input id="item_config_amount_total" placeholder="请输入总补助金额" name="itemConfigAmountTotal"
                                   class="form-control" type="number">
                        </div>
                    </div>-->

                    <div class="form-group">
                        <label for="item_config_amount_per" class="col-sm-2 control-label">每份补助金额：</label>
                        <div class="col-sm-3">
                            <input id="item_config_amount_per" placeholder="请输入每份补助金额" name="itemConfigAmountPer"
                                   class="form-control" type="number">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-2 control-label">人才分类类型：</label>
                        <div class="col-sm-3">
                                <select  name="typeCategoryId" id="type_category_id" class="form-control"type="text">
                                    <option selected="selected" value="0">--请选择--</option>
                                    @for(tc in typeCategories){
                                    <option value="${tc.typeCategoryId}">${tc.typeCategoryName}</option>
                                    @}
                                </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-2 control-label">人才分类补助金额：</label>
                        <div class="col-sm-10" id="type_amount">
                            <!--<input id="item_config_amount_per" placeholder="请输入每份补助金额" name="itemConfigAmountPer"
                                   class="form-control" type="number">-->

                        </div>
                    </div>

                    <div class="form-group">
                        <label for="item_config_service" class="col-sm-2 control-label">服务描述：</label>
                        <div class="col-sm-10">
                            <input id="item_config_service" placeholder="请输入服务描述" name="itemConfigService"
                                   class="form-control" type="text">
                        </div>
                    </div>

                    <div class="form-group">
                        <label  class="col-sm-2 control-label">需要上传证件：</label>
                        <div class="col-sm-10">
                            @for(certificate in certificates){
                            <div class="checkbox checkbox-inline">
                                <input type="checkbox" id="c_${certificate.certificateId}" name="certificates[]" value="${certificate.certificateId}">
                                <label for="c_${certificate.certificateId}"> ${certificate.certificateName} </label>
                            </div>
                            @}
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="item_config_content" class="col-sm-2 control-label">政策详情：</label>
                        <div class="col-sm-10">
                            <textarea id="editor" name="itemConfigContent" id="item_config_content" placeholder="政策详情" autofocus></textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">政策详情附件：</label>
                        <div class="col-sm-10">
                            <div id="u-file"></div>
                            <div class="btns" style="margin-top: 15px;">
                                <div id="picker">选择文件</div>
                            </div>
                            <input type="hidden" name="itemConfigConetentAttachment" id="item_config_conetent_attachment">
                        </div>

                    </div>
                    <!--<div class="form-group">
                        <label  class="col-sm-4 control-label" style="padding-top: 2px;">企业审核：</label>
                        <div class="col-sm-8">
                            <div class="i-checks">
                                <label>
                                    <input type="radio" value="1" checked name="itemConfigCompanyCheck"> <i></i> 是</label>
                                <label>
                                    <input type="radio" value="0" name="itemConfigCompanyCheck"> <i></i> 否</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label  class="col-sm-4 control-label" style="padding-top: 2px;">街道审核：</label>
                        <div class="col-sm-8">
                            <div class="i-checks">
                                <label>
                                    <input type="radio" value="1" checked name="itemConfigStreetCheck"> <i></i> 是</label>
                                <label>
                                    <input type="radio" value="0" name="itemConfigStreetCheck"> <i></i> 否</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label  class="col-sm-4 control-label" style="padding-top: 2px;">平台审核：</label>
                        <div class="col-sm-8">
                            <div class="i-checks">
                                <label>
                                    <input type="radio" value="1" checked name="itemConfigCenterCheck"> <i></i> 是</label>
                                <label>
                                    <input type="radio" value="0" name="itemConfigCenterCheck"> <i></i> 否</label>
                            </div>
                        </div>
                    </div>-->

                    <div class="form-group">
                        <label for="memo" class="col-sm-2 control-label">备注：</label>
                        <div class="col-sm-10">
                            <textarea name="memo" class="form-control" id="memo" rows="5" cols="70"></textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-8 col-sm-offset-2">
                            <button class="btn btn-primary" type="submit">提交</button>
                            <input type="hidden" name="itemId" value="${itemId}">
                            <div class="btn btn-white" onclick="window.history.go(-1)">取消</div>
                        </div>
                    </div>
                    <div id="date-table" style="position: absolute;height: 460px; top:20px;left:43.666668%;" class="col-sm-6">

                        <table data-toggle="table" data-height="460">
                            <thead>
                            <tr>
                                <th>受理时间</th>
                                <th>政策</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td>02-01 至 03-31</td>
                                <td>购房补贴</td>
                            </tr>
                            <tr>
                                <td>04-01 至 06-31</td>
                                <td>人才公寓</td>
                            </tr>
                            <tr>
                                <td>04-01 至 06-31</td>
                                <td>人才公寓</td>
                            </tr>
                            <tr>
                                <td>04-01 至 06-31</td>
                                <td>人才公寓</td>
                            </tr>
                            <tr>
                                <td>04-01 至 06-31</td>
                                <td>人才公寓</td>
                            </tr>
                            <tr>
                                <td>04-01 至 06-31</td>
                                <td>人才公寓</td>
                            </tr>
                            <tr>
                                <td>04-01 至 06-31</td>
                                <td>人才公寓</td>
                            </tr>
                            <tr>
                                <td>04-01 至 06-31</td>
                                <td>人才公寓</td>
                            </tr>
                            <tr>
                                <td>04-01 至 06-31</td>
                                <td>人才公寓</td>
                            </tr>
                            <tr>
                                <td>04-01 至 06-31</td>
                                <td>人才公寓</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
@}
</body>
<script src="/js/plugins/layer/laydate/laydate.js"></script>
<script type="text/javascript" src="/js/plugins/simditor/module.js"></script>
<script type="text/javascript" src="/js/plugins/simditor/hotkeys.js"></script>
<script type="text/javascript" src="/js/plugins/simditor/simditor.js"></script>
<!-- Latest compiled and minified JavaScript -->
<script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/bootstrap-table.min.js"></script>

<!-- Latest compiled and minified Locales -->
<script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/locale/bootstrap-table-zh-CN.min.js"></script>
<script src="/js/plugins/webuploader/webuploader.js"></script>
<script type="text/javascript">
    toastr.options = {
        "closeButton": true,
        "debug": true,
        "progressBar": false,
        "positionClass": "toast-top-center",
        "showDuration": "400",
        "hideDuration": "1000",
        "timeOut": "500",
        "extendedTimeOut": "1000",
        "showEasing": "swing",
        "hideEasing": "linear",
        "showMethod": "fadeIn",
        "hideMethod": "fadeOut"
    }

    $('.date-time').each(function () {
        laydate.render({
            elem: this,
            trigger: 'click'
        });
    });

    // 文件上传
    jQuery(function() {
        var $ = jQuery,
            state = 'pending',
            uploader;

        uploader = WebUploader.create({

            auto: true,

            // 不压缩image
            resize: false,

            // swf文件路径
            swf: '/js/Uploader.swf',

            // 文件接收服务端。
            server: '/upload_item',

            fileNumLimit: 1,

            duplicate: true,

            accept: {
                title: 'Office',
                extensions: 'doc,docx,pdf'
            },
            // 选择文件的按钮。可选。
            // 内部根据当前运行是创建，可能是input元素，也可能是flash.
            pick: '#picker'
        });

        // 当有文件添加进来的时候
        uploader.on( 'fileQueued', function( file ) {

        });

        uploader.on( 'uploadSuccess', function( file,response ) {
            var icon="";
            if(file.ext=="doc"){
                icon = '<i class="fa fa-file-word-o" style="font-size: 20px; margin-right: 2px; padding-top: 5px;"></i>';
            }else{
                icon = '<i class="fa fa-file-pdf-o" style="font-size: 20px; margin-right: 2px; padding-top: 5px;"></i>';
            }

            $("#u-file").html('<div class="info">' + icon + file.name + '</div>');
            $( ".webuploader-pick" ).html('重新上传');
        });

        uploader.on('uploadFinished', function () {
            //清空队列
            uploader.reset();
        });

        uploader.on( 'uploadError', function( file ) {
            var error_str = '<span>上传失败，请重新上传或联系系统管理员</span>';
            $("#item_config_conetent_attachment").val("");
            $("#u-file").html(error_str);
        });

        uploader.on("uploadAccept", function( file, data){
            var res = true;
            if ( data.status=="0") {
                //data即为服务器返回的信息
                // 通过return false来告诉组件，此文件上传有错。
                res = false;
            }else {
                $("#item_config_conetent_attachment").val(data.fileInfo);
            }
            return res;
        });

        /*uploader.on( 'uploadProgress', function( file, percentage ) {
            var $li = $( '#'+file.id ),
                $percent = $li.find('.progress .progress-bar');

            // 避免重复创建
            if ( !$percent.length ) {
                $percent = $('<div class="progress progress-striped active">' +
                    '<div class="progress-bar" role="progressbar" style="width: 0%">' +
                    '</div>' +
                    '</div>').appendTo( $li ).find('.progress-bar');
            }

            $li.find('p.state').text('上传中');

            $percent.css( 'width', percentage * 100 + '%' );
        });

        uploader.on( 'uploadSuccess', function( file,response ) {
            $( '#'+file.id ).find('p.state').text('已上传');
        });

        uploader.on( 'uploadError', function( file ) {
            $( '#'+file.id ).find('p.state').text('上传出错');
        });

        uploader.on( 'uploadComplete', function( file ) {
            $( '#'+file.id ).find('.progress').fadeOut();
        });
        uploader.on("uploadAccept", function( file, data){
            var res = true;
            if ( data.status=="0") {
                //data即为服务器返回的信息
                // 通过return false来告诉组件，此文件上传有错。
                res = false;
            }
            return false;
        });

        uploader.on( 'all', function( type ) {
            if ( type === 'startUpload' ) {
                state = 'pending';
            } else if ( type === 'stopUpload' ) {
                state = 'pending';
            } else if ( type === 'uploadFinished' ) {
                state = 'pending';
            }
        });*/


    });

    laydate.render({
        elem: '#item_config_accept_begin',
        range: '至',
        format: 'MM-dd'
    });

    laydate.render({
        elem: '#item_config_check_time',
        range: '至',
        format: 'MM-dd'
    });

    $(document).ready(function () {

        $("#type_category_id").change(function () {
            $.ajax({
                type: "GET",
                url: "${ctxPath}/item/talent_type?typeCategoryId="+$(this).val(),
                data: $('#viladate_form').serialize(),
                success: function (data) {
                    var htmlStr = "";
                    $.each(data,function(i,t){
                        htmlStr+= '<div class="col-sm-3 pt5">';
                        htmlStr+= '<label class="pull-left control-label">'+t.talentTypeName+'：</label>';
                        htmlStr+= '<div class="pull-left">'
                        htmlStr+= '<input placeholder="请输入金额" name="talentTypeIds[]" value="'+t.talentTypeId+'" class="form-control talent-type" type="hidden">';
                        htmlStr+= '<input placeholder="请输入金额" name="talentTypes[]" class="form-control talent-type" type="number">';
                        htmlStr+= '</div>';
                        htmlStr+= '</div>';
                    });

                    $('#type_amount').html(htmlStr);
                }
            });
        });

        /*<div class="col-sm-3 pt5">
                                <label class="pull-left control-label">A类：</label>
                                <div class="pull-left">
                                    <input placeholder="请输入发放频率(例：0.5月发放一次)"
                                           name="itemConfigSendRate" class="form-control talent-type" type="number">
                                </div>
                            </div>*/


        //富文本 编辑器
        var editor = new Simditor({
            textarea: $('#editor'),
            upload: false,
            toolbar: [
                'title', 'bold', 'italic', 'underline', 'strikethrough', 'fontScale',
                'color', 'ol', 'ul', 'blockquote', 'table', 'link', 'hr', 'indent',
                'outdent', 'alignment'
            ]
            //optional options
        });

        //初始补助发放方式必填项
        var type = $('input[name="itemConfigType"]:checked').val();
        if(type==0){
            $("#item_config_service").attr("required", true);
            $("#item_config_amount_total,#item_config_amount_per").attr("readonly", true);
        } else {
            $("#item_config_amount_total,#item_config_amount_per").attr("required", true);
            $("#item_config_service").attr("readonly", true);
        }

        // itemConfigTType

        if($('input[name="itemConfigTType"]:checked').val()==0){
            $(".talent-type").attr("readonly", true);
            $("#type_category_id").attr("disabled", true);
        }else {
            $(".talent-type").attr("readonly", true);
            $("#type_category_id").attr("disabled", true);
        }

        $("input:radio[name='itemConfigTType']").on('ifChecked', function (event) {
            if ($(this).val() == 0) {
                $(".talent-type").attr("readonly", true);
                $("#item_config_amount_per").attr("readonly", false);
                $('#item_config_amount_per').parent().prev().append(
                    '<span class="red-star" style="color:red">*</span>'
                );
                $("#type_category_id").attr("disabled", true);
            }else {
                $(".talent-type").attr("readonly", false);
                $("#item_config_amount_per").val("");
                $("#item_config_amount_per").attr("readonly", true);
                $('#item_config_amount_per').parent().parent().removeClass("has-error");
                $("#item_config_amount_per").removeAttr("required");
                $("#type_category_id").removeAttr("disabled");
                $('#item_config_amount_per').parent().prev().children().remove();
            }
        });
        //初始化发放频率为月时，设置发放频率为必填
        if($('input[name="itemConfigSendType"]:checked').val()==1){
            $("#item_config_send_rate").attr("required", true);
        }

        // 服务or现金方式change改变相应必填项
        $("input:radio[name='itemConfigType']").on('ifChecked', function (event) {
            if ($(this).val() == 0) {//服务

                //清空input
                $('#item_config_amount_total,#item_config_amount_per').val("");
                //添加readonly属性
                $('#item_config_amount_total,#item_config_amount_per').attr('readonly', true);

                $('#item_config_amount_total').parent().parent().removeClass("has-error");
                $('#item_config_amount_per').parent().parent().removeClass("has-error");

                $('#item_config_amount_total').parent().prev().children().remove();
                $('#item_config_amount_per').parent().prev().children().remove();

                $('#item_config_amount_total').next().remove();
                $('#item_config_amount_per').next().remove();

                //移除required属性
                $("#item_config_amount_total,#item_config_amount_per").removeAttr("required");

                //添加required属性
                $("#item_config_service").attr("required", true);
                $("#item_config_service").removeAttr("readonly");

                $('#item_config_service').parent().prev().append(
                    '<span class="red-star" style="color:red">*</span>'
                );


            } else { //现金
                $('#item_config_amount_total,#item_config_amount_per').removeAttr('readonly');
                // $('#item_config_amount_per').removeAttr('readonly');

                $("#item_config_amount_total,#item_config_amount_per").attr("required", true);


                $('#item_config_amount_total').parent().prev().append(
                    '<span class="red-star" style="color:red">*</span>'
                );

                $('#item_config_amount_per').parent().prev().append(
                    '<span class="red-star" style="color:red">*</span>'
                );

                $("#item_config_service").val("");
                $('#item_config_service').removeAttr('required');
                $('#item_config_service').parent().parent().removeClass("has-error");
                $('#item_config_service').next().remove();
                $("#item_config_service").attr("readonly", true);
                $('#item_config_service').parent().prev().children().remove();
            }
        });

        //发放方式change 设置必填项
        $("input:radio[name='itemConfigSendType']").on('ifChecked', function (event) {
            if ($(this).val() == 1) {
                $('#item_config_send_rate').removeAttr("readonly");
                $('#item_config_send_rate').val(1);
                $("#item_config_send_rate").attr("required", true);
                $('#item_config_send_rate').parent().prev().append(
                    '<span class="red-star" style="color:red">*</span>'
                );
                countAmount();
            } else {
                $("#item_config_send_rate").val("");
                $("#item_config_send_rate").attr("readonly", true);
                $('#item_config_send_rate').removeAttr('required');
                $('#item_config_send_rate').parent().parent().removeClass("has-error");
                $('#item_config_send_rate').next().remove();
                $('#item_config_send_rate').parent().prev().children().remove();
                countAmount();
            }
        });

        $("#item_config_amount_total").blur(function () {
            countAmount();

        });
        $("#item_config_send_rate").blur(function () {
            countAmount();
        });
    });

    //计算每份金额
    function countAmount(){
        if($("#item_config_amount_total").val()!=''){
            var item_length = ${item_length};
            var amount = 0;
            //0:一次性 1:月 2:年
            var send_type=$('input[name="itemConfigSendType"]:checked').val();
            if(send_type==0){
                amount = $("#item_config_amount_total").val()*1;
            }else if(send_type==2){
                amount = $("#item_config_amount_total").val()/(item_length/12);
            }else{
                var rate = $("#item_config_send_rate").val();
                amount = $("#item_config_amount_total").val()/(item_length/rate);
            }
            $('#item_config_amount_per').val(amount.toFixed(2));
        }
    }

    $.validator.setDefaults({
        highlight: function (e) {
            $(e).closest(".form-group").removeClass("has-success").addClass("has-error")
        }, success: function (e) {
            e.closest(".form-group").removeClass("has-error").addClass("has-success")
        }, errorElement: "span", errorPlacement: function (e, r) {
            e.appendTo(r.is(":radio") || r.is(":checkbox") ? r.parent().parent().parent() : r.parent())
        }, errorClass: "help-block m-b-none", validClass: "help-block m-b-none"
    }), $().ready(function () {
        // $("#commentForm").validate();
        $(".i-checks").iCheck({checkboxClass: "icheckbox_square-green", radioClass: "iradio_square-green",});
        var e = "<i class='fa fa-times-circle'></i> ";
        $("#viladate_form").validate({
            rules: {
                itemConfigId: {
                    required: true,
                    remote: {
                        url: "${ctxPath}/checkUnique",
                        data: {
                            user_name: function () {
                                return $("#itemConfigId").val();
                            },
                            table: function () {
                                return "talent_item_config";
                            }
                        }
                    }
                },
                password: {
                    required: true
                },
                comfirmPassword: {
                    required: true,
                    equalTo: "#password"
                }
            },
            messages: {
                userName: {
                    required: e + "请输入练考计划名称",
                    remote: e + "该用户名已存在"
                },
                password: {
                    required: e + "请输入用户密码"
                },
                comfirmPassword: {
                    required: e + "请确认密码",
                    equalTo: e + "两次密码不一致"
                }
            },
            submitHandler: function () {
                $.ajax({
                    type: "POST",
                    url: "${ctxPath}/item/add_config",
                    data: $('#viladate_form').serialize(),
                    success: function (data) {
                        if (data['status'] == 1) {
                            toastr.success(data['body']);
                            setTimeout('window.location.href="/item/config.html?itemId=' + data["data"] + '"', 900);
                        } else {
                            toastr.success(data['body']);
                        }
                    }
                });
            }
        }), $('input[required]').parent().prev().append(
            '<span style="color:red">*</span>'
        );
    });

</script>
</html>